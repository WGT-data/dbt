---
phase: 06-source-freshness-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - models/staging/adjust/_adjust__sources.yml
  - models/staging/amplitude/_amplitude__sources.yml
  - tests/singular/test_adjust_amplitude_mapping_staleness.sql
autonomous: false

must_haves:
  truths:
    - "dbt source freshness reports pass/warn/error status for all 13 Adjust S3 activity tables"
    - "dbt source freshness reports pass/warn/error status for Adjust API REPORT_DAILY_RAW table"
    - "dbt source freshness reports pass/warn/error status for both Amplitude data share tables"
    - "Singular test detects when ADJUST_AMPLITUDE_DEVICE_MAPPING table is stale (>30 days since LAST_ALTERED)"
    - "Source freshness runs as a separate scheduled job in dbt Cloud (not embedded in build jobs)"
  artifacts:
    - path: "models/staging/adjust/_adjust__sources.yml"
      provides: "Source freshness config for Adjust S3 and API sources"
      contains: "warn_after"
    - path: "models/staging/amplitude/_amplitude__sources.yml"
      provides: "Source freshness config for Amplitude data share"
      contains: "warn_after"
    - path: "tests/singular/test_adjust_amplitude_mapping_staleness.sql"
      provides: "Singular test for static mapping table staleness detection"
      contains: "ADJUST_AMPLITUDE_DEVICE_MAPPING"
  key_links:
    - from: "models/staging/adjust/_adjust__sources.yml"
      to: "ADJUST.S3_DATA.*"
      via: "loaded_at_field with TO_TIMESTAMP(CREATED_AT)"
      pattern: "TO_TIMESTAMP\\(CREATED_AT\\)"
    - from: "models/staging/adjust/_adjust__sources.yml"
      to: "ADJUST.API_DATA.REPORT_DAILY_RAW"
      via: "loaded_at_field with DAY column"
      pattern: "loaded_at_field.*DAY"
    - from: "models/staging/amplitude/_amplitude__sources.yml"
      to: "AMPLITUDEANALYTICS_AMPLITUDE_DB_364926_SHARE.SCHEMA_726530.*"
      via: "Metadata-based freshness (no loaded_at_field)"
      pattern: "warn_after.*error_after"
    - from: "tests/singular/test_adjust_amplitude_mapping_staleness.sql"
      to: "INFORMATION_SCHEMA.TABLES"
      via: "LAST_ALTERED comparison"
      pattern: "DATEDIFF.*LAST_ALTERED.*30"
---

<objective>
Configure source freshness monitoring for Adjust and Amplitude sources, create a static table staleness test, and document dbt Cloud job setup.

Purpose: This is the final phase of milestone v1.0. Source freshness monitoring ensures the MMM pipeline's input data sources meet latency SLAs and that stale static tables are detected before they cause silent data quality issues.

Output: Updated source YAML files with freshness configuration, a new singular test for mapping table staleness, and a dbt Cloud job configured for scheduled freshness checks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-source-freshness-observability/06-RESEARCH.md
@models/staging/adjust/_adjust__sources.yml
@models/staging/amplitude/_amplitude__sources.yml
@models/staging/adjust_api/_adjust_api__sources.yml
@models/staging/adjust/v_stg_adjust__touchpoints.sql
@models/staging/adjust/stg_adjust__report_daily.sql
@tests/singular/test_ad_partner_mapping_consistency.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure source freshness for Adjust and Amplitude sources</name>
  <files>
    models/staging/adjust/_adjust__sources.yml
    models/staging/amplitude/_amplitude__sources.yml
  </files>
  <action>
Edit two existing source YAML files to add freshness configuration. Do NOT recreate these files from scratch -- add freshness properties to the existing structure.

**1. models/staging/adjust/_adjust__sources.yml**

This file has TWO source groups. Add freshness to BOTH:

**Source group `adjust` (S3_DATA, 13 activity tables):**
- Add `freshness:` block at the source level (NOT table level) with:
  - `warn_after: {count: 12, period: hour}`
  - `error_after: {count: 24, period: hour}`
- Add `loaded_at_field: "TO_TIMESTAMP(CREATED_AT)"` at the source level
- This cascades to all 13 S3 activity tables automatically
- The CREATED_AT column is an epoch timestamp (seconds since 1970) present on all S3 activity tables. TO_TIMESTAMP converts it to TIMESTAMP_NTZ for freshness comparison.
- Keep ALL existing table definitions, descriptions, and structure exactly as-is

**Source group `adjust_api_data` (API_DATA, REPORT_DAILY_RAW):**
- Add `freshness:` block at the source level with:
  - `warn_after: {count: 30, period: hour}`
  - `error_after: {count: 48, period: hour}`
- Add `loaded_at_field: "DAY"` at the source level
- The DAY column is a DATE column in REPORT_DAILY_RAW (confirmed in stg_adjust__report_daily.sql which does `SELECT DAY AS DATE`)
- More generous thresholds because API data is batch-loaded, not real-time
- Keep existing table definition and description exactly as-is

**IMPORTANT:** Do NOT add freshness to the `adjust_api` source in `_adjust_api__sources.yml`. That file has a DUPLICATE definition of REPORT_DAILY_RAW. The active reference used by `stg_adjust__report_daily.sql` is `source('adjust_api_data', 'REPORT_DAILY_RAW')` in `_adjust__sources.yml`. Adding freshness to both would cause duplicate checks.

**2. models/staging/amplitude/_amplitude__sources.yml**

- Add `freshness:` block at the source level with:
  - `warn_after: {count: 6, period: hour}`
  - `error_after: {count: 12, period: hour}`
- Do NOT add a `loaded_at_field` -- omit it entirely. This is intentional: Amplitude is a Snowflake data share with no timestamp columns. dbt 1.7+ automatically falls back to Snowflake INFORMATION_SCHEMA.TABLES.LAST_ALTERED when loaded_at_field is omitted.
- Keep ALL existing table definitions and descriptions exactly as-is
  </action>
  <verify>
Verify edits are correct:
- `_adjust__sources.yml` has `freshness:` and `loaded_at_field:` on BOTH source groups (`adjust` and `adjust_api_data`)
- `_amplitude__sources.yml` has `freshness:` but NO `loaded_at_field`
- `_adjust_api__sources.yml` is UNCHANGED (no freshness added)
- All existing table definitions preserved (table count unchanged: 13 S3 + 1 API + 2 Amplitude)
- YAML is valid (proper indentation, no syntax errors)
  </verify>
  <done>
Source freshness is configured for all Adjust S3 tables (12h warn, 24h error, epoch CREATED_AT), Adjust API (30h warn, 48h error, DAY column), and Amplitude data share (6h warn, 12h error, metadata-based). Freshness cascades to all tables within each source group.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create singular test for static mapping table staleness</name>
  <files>
    tests/singular/test_adjust_amplitude_mapping_staleness.sql
  </files>
  <action>
Create a new singular test that detects when the ADJUST_AMPLITUDE_DEVICE_MAPPING static table hasn't been refreshed in more than 30 days.

**File: tests/singular/test_adjust_amplitude_mapping_staleness.sql**

Follow the established pattern from test_ad_partner_mapping_consistency.sql (header comment block, zero rows = pass).

The test should:

1. Start with a SQL comment block explaining:
   - What it tests (static mapping table staleness via INFORMATION_SCHEMA.TABLES.LAST_ALTERED)
   - Why it matters (stale mapping data causes silent device matching degradation)
   - What "fail" means (table hasn't been updated in >30 days)

2. Query `ADJUST.INFORMATION_SCHEMA.TABLES` (the mapping table is in the ADJUST database based on project context -- it's alongside the S3_DATA and API_DATA schemas)
   - Filter WHERE TABLE_NAME = 'ADJUST_AMPLITUDE_DEVICE_MAPPING'
   - Filter WHERE DATEDIFF('day', LAST_ALTERED, CURRENT_TIMESTAMP()) > 30
   - Note: We don't know the exact schema. Use a broader query approach:
     ```sql
     SELECT
         TABLE_CATALOG AS database_name,
         TABLE_SCHEMA AS schema_name,
         TABLE_NAME,
         LAST_ALTERED,
         DATEDIFF('day', LAST_ALTERED, CURRENT_TIMESTAMP()) AS days_since_update,
         ROW_COUNT,
         'Static mapping table stale - last updated ' ||
           DATEDIFF('day', LAST_ALTERED, CURRENT_TIMESTAMP()) || ' days ago' AS failure_reason
     FROM ADJUST.INFORMATION_SCHEMA.TABLES
     WHERE TABLE_NAME = 'ADJUST_AMPLITUDE_DEVICE_MAPPING'
       AND DATEDIFF('day', LAST_ALTERED, CURRENT_TIMESTAMP()) > 30
     ```

3. Return zero rows when the table was updated within 30 days (test passes)
4. Return one row with diagnostic info when the table is stale (test fails)

**NOTE:** This test will currently FAIL because STATE.md says the table is "stale Nov 2025" (last updated ~3 months ago). This is expected and correct -- the test is working as designed by detecting the staleness. The test should be configured with `severity: warn` in the schema YAML if the team wants it non-blocking, but for now create it as a standard singular test (default severity = error). The team can adjust severity later.
  </action>
  <verify>
- File exists at tests/singular/test_adjust_amplitude_mapping_staleness.sql
- SQL references ADJUST.INFORMATION_SCHEMA.TABLES
- SQL filters on TABLE_NAME = 'ADJUST_AMPLITUDE_DEVICE_MAPPING'
- SQL filters on DATEDIFF > 30
- SQL has header comment block
- SQL returns zero rows when table is fresh (test passes)
  </verify>
  <done>
Singular test exists that queries INFORMATION_SCHEMA.TABLES.LAST_ALTERED to detect when ADJUST_AMPLITUDE_DEVICE_MAPPING hasn't been refreshed in >30 days. Returns diagnostic columns (database, schema, table name, days since update, row count, failure reason) for debugging.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Configure dbt Cloud source freshness job</name>
  <what-built>Source freshness YAML configuration for Adjust (S3 + API) and Amplitude sources, plus static table staleness test. All code changes are complete.</what-built>
  <how-to-verify>
    1. In dbt Cloud, create a new Job:
       - **Name:** "Source Freshness Monitoring"
       - **Environment:** Production
       - **Commands:** `dbt source freshness`
       - **Schedule:** Every 6 hours (cron: `0 */6 * * *`)
       - **Generate docs on run:** No
       - Enable email notifications on failure

    2. Run the job manually once to verify:
       - All 13 Adjust S3 activity tables report freshness status
       - REPORT_DAILY_RAW reports freshness status
       - Both Amplitude tables report freshness status (via metadata)
       - Check for any "column not found" errors (would indicate loaded_at_field misconfiguration)

    3. Note: The staleness test (test_adjust_amplitude_mapping_staleness.sql) runs with `dbt test`, not `dbt source freshness`. It will be included in the normal test suite.
  </how-to-verify>
  <resume-signal>Type "configured" when the dbt Cloud freshness job is set up and verified, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
All source freshness configuration and staleness detection is complete:
- `grep -c "warn_after" models/staging/adjust/_adjust__sources.yml` returns 2 (one per source group)
- `grep -c "loaded_at_field" models/staging/adjust/_adjust__sources.yml` returns 2 (one per source group)
- `grep -c "warn_after" models/staging/amplitude/_amplitude__sources.yml` returns 1
- `grep "loaded_at_field" models/staging/amplitude/_amplitude__sources.yml` returns NO matches (metadata-based)
- `ls tests/singular/test_adjust_amplitude_mapping_staleness.sql` exists
- `grep "INFORMATION_SCHEMA" tests/singular/test_adjust_amplitude_mapping_staleness.sql` returns a match
- `grep "freshness" models/staging/adjust_api/_adjust_api__sources.yml` returns NO matches (unchanged, no duplicate)
</verification>

<success_criteria>
- FRESH-01: Adjust S3 sources have freshness with TO_TIMESTAMP(CREATED_AT), warn 12h, error 24h
- FRESH-01: Adjust API source has freshness with DAY column, warn 30h, error 48h
- FRESH-02: Amplitude sources have freshness with metadata-based approach (no loaded_at_field), warn 6h, error 12h
- FRESH-03: Singular test detects ADJUST_AMPLITUDE_DEVICE_MAPPING staleness >30 days via INFORMATION_SCHEMA
- FRESH-04: dbt Cloud job configured to run `dbt source freshness` every 6 hours (human-verified checkpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/06-source-freshness-observability/06-01-SUMMARY.md`
</output>
