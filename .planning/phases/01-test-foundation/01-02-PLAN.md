---
phase: 01-test-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - models/intermediate/_int_mta__models.yml
  - models/intermediate/_int_device_mapping__models.yml
  - models/intermediate/_int_cohort__models.yml
  - models/intermediate/_int_revenue__models.yml
autonomous: true

must_haves:
  truths:
    - "Intermediate model composite keys have unique and not_null tests defined"
    - "Device mapping foreign key has a relationships test with severity warn"
    - "Platform columns at intermediate layer have accepted_values tests"
    - "All intermediate tests use forward-looking 60-day where filter"
  artifacts:
    - path: "models/intermediate/_int_mta__models.yml"
      provides: "Tests for int_mta__user_journey and int_mta__touchpoint_credit"
      contains: "data_tests"
    - path: "models/intermediate/_int_device_mapping__models.yml"
      provides: "Tests for int_adjust_amplitude__device_mapping"
      contains: "data_tests"
    - path: "models/intermediate/_int_cohort__models.yml"
      provides: "Tests for int_user_cohort__attribution and int_user_cohort__metrics"
      contains: "data_tests"
    - path: "models/intermediate/_int_revenue__models.yml"
      provides: "Tests for int_revenue__user_summary"
      contains: "data_tests"
  key_links:
    - from: "models/intermediate/_int_mta__models.yml"
      to: "int_adjust_amplitude__device_mapping"
      via: "relationships test"
      pattern: "relationships"
    - from: "models/intermediate/_int_mta__models.yml"
      to: "int_mta__user_journey"
      via: "JOURNEY_ROW_KEY unique test"
      pattern: "JOURNEY_ROW_KEY"
    - from: "models/intermediate/_int_device_mapping__models.yml"
      to: "int_adjust_amplitude__device_mapping"
      via: "composite key test"
      pattern: "unique_combination_of_columns"
---

<objective>
Add data quality tests to all intermediate models covering composite key uniqueness, foreign key relationships (device mapping), platform accepted_values, and forward-looking filters.

Purpose: Establishes the intermediate-layer test coverage (TEST-02, TEST-03, TEST-04, TEST-05) which is the critical layer where device mapping and MTA attribution happen. The relationships test (TEST-03) between user_journey and device_mapping is the most important test for catching broken device ID matching -- the exact problem Phase 3 will fix. Setting `severity: warn` acknowledges the known iOS match rate limitation while still tracking the metric.

Output: Four intermediate model YAML files with generic tests covering composite keys, referential integrity, and platform constraints.
</objective>

<execution_context>
@/Users/riley/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riley/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-foundation/01-RESEARCH.md
@.planning/phases/01-test-foundation/01-01-SUMMARY.md
@models/intermediate/int_adjust_amplitude__device_mapping.sql
@models/intermediate/int_mta__user_journey.sql
@models/intermediate/int_mta__touchpoint_credit.sql
@models/intermediate/int_user_cohort__attribution.sql
@models/intermediate/int_user_cohort__metrics.sql
@models/intermediate/int_revenue__user_summary.sql
@models/intermediate/_int_mta__models.yml
@models/intermediate/_int_skan__models.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests to MTA intermediate models and create device mapping tests</name>
  <files>models/intermediate/_int_mta__models.yml, models/intermediate/_int_device_mapping__models.yml</files>
  <action>
1. UPDATE (not replace) `models/intermediate/_int_mta__models.yml` -- this file already has model descriptions for int_mta__user_journey and int_mta__touchpoint_credit. ADD `data_tests:` blocks to the existing model entries. Preserve all existing descriptions and column documentation.

For `int_mta__user_journey` (grain: one row per device+touchpoint+install, surrogate key: JOURNEY_ROW_KEY):
- Column-level: JOURNEY_ROW_KEY: unique + not_null with `where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"`
- Column-level: DEVICE_ID: not_null with same where filter
- Column-level: DEVICE_ID: relationships test to `ref('int_adjust_amplitude__device_mapping')` field `ADJUST_DEVICE_ID` with `severity: warn` and where filter. Use severity warn because iOS IDFA match rate is structurally ~1.4% (ATT limitation, DMAP-04) and Android mapping is not yet fixed (Phase 3).
- Column-level: PLATFORM: not_null + accepted_values ['iOS', 'Android'] with where filter

For `int_mta__touchpoint_credit` (grain: one row per device+touchpoint+install, surrogate key: JOURNEY_ROW_KEY):
- Column-level: JOURNEY_ROW_KEY: unique + not_null with `where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"`
- Column-level: PLATFORM: not_null + accepted_values ['iOS', 'Android'] with where filter

2. CREATE `models/intermediate/_int_device_mapping__models.yml` with tests for int_adjust_amplitude__device_mapping.

For `int_adjust_amplitude__device_mapping` (grain: one row per adjust_device+amplitude_user+platform, composite unique_key: ['ADJUST_DEVICE_ID', 'AMPLITUDE_USER_ID', 'PLATFORM']):
- Model-level: `dbt_utils.unique_combination_of_columns` test on ADJUST_DEVICE_ID, AMPLITUDE_USER_ID, PLATFORM with `where: "FIRST_SEEN_AT >= DATEADD(day, -60, CURRENT_DATE)"`
- Column-level: ADJUST_DEVICE_ID: not_null with where filter
- Column-level: AMPLITUDE_USER_ID: not_null with where filter
- Column-level: PLATFORM: not_null + accepted_values ['iOS', 'Android'] with where filter

Use `data_tests:` key and `arguments:` wrapper per dbt v1.10.5+ syntax.

CRITICAL: When updating _int_mta__models.yml, you MUST preserve all existing content (descriptions, columns). Add `data_tests:` sections to existing column entries where they already exist, and add new column entries for columns not yet documented (like JOURNEY_ROW_KEY, PLATFORM).
  </action>
  <verify>
Verify YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('models/intermediate/_int_mta__models.yml'))"`
Verify YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('models/intermediate/_int_device_mapping__models.yml'))"`
Grep for expected patterns in _int_mta__models.yml: `relationships`, `severity: warn`, `JOURNEY_ROW_KEY`, `accepted_values`.
Grep for expected patterns in _int_device_mapping__models.yml: `unique_combination_of_columns`, `ADJUST_DEVICE_ID`.
Verify existing descriptions preserved: grep for `Maps all marketing touchpoints` in _int_mta__models.yml (should still be there).
  </verify>
  <done>
_int_mta__models.yml updated with: unique + not_null on JOURNEY_ROW_KEY for both MTA models, relationships test (severity: warn) on user_journey DEVICE_ID to device_mapping, accepted_values on PLATFORM. All existing descriptions preserved. _int_device_mapping__models.yml created with: unique_combination_of_columns on composite key, not_null on key columns, accepted_values on PLATFORM. All with 60-day where filters.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cohort and revenue intermediate model tests</name>
  <files>models/intermediate/_int_cohort__models.yml, models/intermediate/_int_revenue__models.yml</files>
  <action>
1. CREATE `models/intermediate/_int_cohort__models.yml` with tests for int_user_cohort__attribution and int_user_cohort__metrics.

For `int_user_cohort__attribution` (grain: one row per user_id/platform, composite unique_key: ['USER_ID', 'PLATFORM']):
- Model-level: `dbt_utils.unique_combination_of_columns` test on USER_ID, PLATFORM with `where: "INSTALL_TIME >= DATEADD(day, -60, CURRENT_DATE)"`
- Column-level: USER_ID: not_null with where filter
- Column-level: PLATFORM: not_null + accepted_values ['iOS', 'Android'] with where filter

For `int_user_cohort__metrics` (grain: one row per user_id/platform, composite unique_key: ['USER_ID', 'PLATFORM']):
- Model-level: `dbt_utils.unique_combination_of_columns` test on USER_ID, PLATFORM with `where: "INSTALL_TIME >= DATEADD(day, -60, CURRENT_DATE)"`
- Column-level: USER_ID: not_null with where filter
- Column-level: PLATFORM: not_null + accepted_values ['iOS', 'Android'] with where filter

2. CREATE `models/intermediate/_int_revenue__models.yml` with tests for int_revenue__user_summary.

For `int_revenue__user_summary` (grain: one row per user_id, PK: USER_ID):
- Column-level: USER_ID: unique + not_null (no where filter needed -- this model has no obvious timestamp column for filtering; the model re-aggregates all data for users with recent activity, so the full result set is valid for testing)

NOTE: int_revenue__user_summary does NOT have a PLATFORM column (the SQL only selects USER_ID, PURCHASE_COUNT, TOTAL_REVENUE), so do NOT add platform accepted_values test for this model.

NOTE: int_user_cohort__metrics has INSTALL_TIME as its timestamp column (from the join with device mapping). Use this for the where filter.

Use `data_tests:` key and `arguments:` wrapper per dbt v1.10.5+ syntax.
  </action>
  <verify>
Verify YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('models/intermediate/_int_cohort__models.yml'))"`
Verify YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('models/intermediate/_int_revenue__models.yml'))"`
Grep for patterns: `unique_combination_of_columns` in _int_cohort__models.yml, `unique` and `not_null` in _int_revenue__models.yml.
  </verify>
  <done>
_int_cohort__models.yml created with: unique_combination_of_columns on composite keys for both cohort models, not_null on key columns, accepted_values on PLATFORM. All with 60-day where filters. _int_revenue__models.yml created with: unique + not_null on USER_ID for int_revenue__user_summary (no platform test since model lacks PLATFORM column).
  </done>
</task>

</tasks>

<verification>
1. All four intermediate YAML files exist and parse as valid YAML
2. Every intermediate model with a composite key has unique_combination_of_columns + not_null tests
3. int_mta__user_journey has a relationships test to int_adjust_amplitude__device_mapping with severity: warn (TEST-03)
4. Every model with a PLATFORM column has accepted_values ['iOS', 'Android'] + not_null tests (TEST-04)
5. Every test (except int_revenue__user_summary which has no timestamp) has a `where` config with 60-day lookback (TEST-05)
6. Existing _int_mta__models.yml descriptions are preserved (not overwritten)
7. No test on models that lack the tested column (e.g., no PLATFORM test on int_revenue__user_summary)
</verification>

<success_criteria>
- 4 intermediate model YAML files created/updated with tests covering TEST-02 (composite keys), TEST-03 (FK relationships), TEST-04 (accepted_values), TEST-05 (where filters)
- relationships test uses severity: warn with comment referencing iOS ATT limitation
- All tests use `data_tests:` key with `arguments:` wrapper syntax
- Existing model documentation in _int_mta__models.yml preserved
- YAML files parse without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-foundation/01-02-SUMMARY.md`
</output>
