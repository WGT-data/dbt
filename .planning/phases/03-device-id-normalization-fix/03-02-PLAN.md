---
phase: 03-mta-limitations-mmm-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - models/intermediate/int_mmm__daily_channel_spend.sql
  - models/intermediate/int_mmm__daily_channel_installs.sql
  - models/intermediate/int_mmm__daily_channel_revenue.sql
  - models/intermediate/_int_mmm__models.yml
autonomous: true

must_haves:
  truths:
    - "Daily channel spend aggregation combines Supermetrics and Adjust API spend data at DATE+PLATFORM+CHANNEL grain"
    - "Daily channel installs are counted from device-level Adjust S3 data at DATE+PLATFORM+CHANNEL grain"
    - "Daily channel revenue uses Adjust API pre-aggregated revenue at DATE+PLATFORM+CHANNEL grain (no dependency on broken device mapping)"
    - "All three intermediate models use consistent AD_PARTNER channel taxonomy via the network_mapping seed"
  artifacts:
    - path: "models/intermediate/int_mmm__daily_channel_spend.sql"
      provides: "Daily spend by channel and platform"
      contains: "stg_supermetrics__adj_campaign"
    - path: "models/intermediate/int_mmm__daily_channel_installs.sql"
      provides: "Daily installs by channel and platform"
      contains: "v_stg_adjust__installs"
    - path: "models/intermediate/int_mmm__daily_channel_revenue.sql"
      provides: "Daily revenue by channel and platform"
      contains: "stg_adjust__report_daily"
    - path: "models/intermediate/_int_mmm__models.yml"
      provides: "Schema definitions for MMM intermediate models"
      contains: "int_mmm__daily_channel"
  key_links:
    - from: "int_mmm__daily_channel_spend.sql"
      to: "stg_supermetrics__adj_campaign"
      via: "ref()"
      pattern: "ref\\('stg_supermetrics__adj_campaign'\\)"
    - from: "int_mmm__daily_channel_installs.sql"
      to: "v_stg_adjust__installs"
      via: "ref()"
      pattern: "ref\\('v_stg_adjust__installs'\\)"
    - from: "int_mmm__daily_channel_revenue.sql"
      to: "stg_adjust__report_daily"
      via: "ref()"
      pattern: "ref\\('stg_adjust__report_daily'\\)"
---

<objective>
Build three MMM intermediate models that aggregate spend, installs, and revenue at daily+channel+platform grain.

Purpose: These are the building blocks for the MMM daily summary mart. Each model aggregates one metric type from existing staging models. Critically, the revenue model uses Adjust API's pre-aggregated revenue data (stg_adjust__report_daily) rather than the user-level cohort pipeline (which depends on the broken device mapping). This makes the MMM pipeline fully independent of MTA device matching.

Output: 3 SQL model files + 1 schema YAML file in models/intermediate/.
</objective>

<execution_context>
@/Users/riley/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riley/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/03-device-id-normalization-fix/03-RESEARCH.md
@models/staging/supermetrics/stg_supermetrics__adj_campaign.sql
@models/staging/adjust/stg_adjust__report_daily.sql
@models/staging/adjust/v_stg_adjust__installs.sql
@seeds/network_mapping.csv
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create daily channel spend and installs intermediate models</name>
  <files>
models/intermediate/int_mmm__daily_channel_spend.sql
models/intermediate/int_mmm__daily_channel_installs.sql
  </files>
  <action>
**File 1: `models/intermediate/int_mmm__daily_channel_spend.sql`**

Create an incremental model that aggregates daily spend by channel and platform. Use `merge` strategy with unique_key `['DATE', 'PLATFORM', 'CHANNEL']`.

Logic:
1. CTE `supermetrics_spend`: Select from `{{ ref('stg_supermetrics__adj_campaign') }}`. Join to `{{ ref('network_mapping') }}` on `PARTNER_NAME = SUPERMETRICS_PARTNER_NAME` to get standardized `AD_PARTNER` as CHANNEL. Group by DATE, PLATFORM, CHANNEL. SUM(COST) as SPEND. Also SUM IMPRESSIONS, CLICKS, INSTALLS as supplementary metrics. Apply incremental filter: `WHERE DATE >= DATEADD(day, -7, (SELECT MAX(DATE) FROM {{ this }}))`.

2. CTE `adjust_api_spend`: Select from `{{ ref('stg_adjust__report_daily') }}`. Join to `{{ ref('network_mapping') }}` on `PARTNER_NAME = ADJUST_NETWORK_NAME` to get standardized `AD_PARTNER` as CHANNEL. Group by DATE, PLATFORM, CHANNEL. SUM(COST) as SPEND. Apply same incremental filter.

3. Final SELECT: UNION the two spend sources. If both sources have data for the same DATE+PLATFORM+CHANNEL, prefer Supermetrics (it's the primary spend source). Use a final GROUP BY with logic that takes MAX from either source, or use a QUALIFY ROW_NUMBER to dedupe.

Actually, simpler approach: Use ONLY `stg_supermetrics__adj_campaign` for spend since it's the primary spend data source and already has COST. The Adjust API `stg_adjust__report_daily` has `NETWORK_COST` and `COST` but these may overlap with Supermetrics. To avoid double-counting, use Supermetrics as the single source of truth for spend.

Revised logic:
```sql
{{ config(
    materialized='incremental',
    unique_key=['DATE', 'PLATFORM', 'CHANNEL'],
    incremental_strategy='merge',
    tags=['mmm', 'spend']
) }}

WITH spend_with_channel AS (
    SELECT
        s.DATE,
        s.PLATFORM,
        COALESCE(nm.AD_PARTNER, 'Other') AS CHANNEL,
        SUM(s.COST) AS SPEND,
        SUM(s.IMPRESSIONS) AS IMPRESSIONS,
        SUM(s.CLICKS) AS CLICKS,
        SUM(s.PAID_INSTALLS) AS PAID_INSTALLS
    FROM {{ ref('stg_supermetrics__adj_campaign') }} s
    -- Note: Snowflake treats unquoted identifiers as case-insensitive.
    -- The seed CSV has lowercase headers (supermetrics_partner_name) but since
    -- quote_columns is not set in dbt_project.yml, Snowflake uppercases them
    -- internally. Using UPPERCASE here for project consistency.
    LEFT JOIN {{ ref('network_mapping') }} nm
        ON s.PARTNER_NAME = nm.SUPERMETRICS_PARTNER_NAME
    WHERE s.DATE IS NOT NULL
      AND s.COST > 0
    {% if is_incremental() %}
      AND s.DATE >= DATEADD(day, -7, (SELECT MAX(DATE) FROM {{ this }}))
    {% endif %}
    GROUP BY 1, 2, 3
)

SELECT
    DATE,
    PLATFORM,
    CHANNEL,
    SPEND,
    IMPRESSIONS,
    CLICKS,
    PAID_INSTALLS
FROM spend_with_channel
```

Add a header comment explaining:
- This model aggregates daily marketing spend by channel and platform for MMM input
- Source: Supermetrics adj_campaign (primary spend data)
- Channel mapping via network_mapping seed for consistent taxonomy
- Grain: one row per DATE + PLATFORM + CHANNEL

**File 2: `models/intermediate/int_mmm__daily_channel_installs.sql`**

Create an incremental model that aggregates daily installs from device-level Adjust S3 data. This gives accurate install counts by counting distinct devices.

```sql
{{ config(
    materialized='incremental',
    unique_key=['DATE', 'PLATFORM', 'CHANNEL'],
    incremental_strategy='merge',
    tags=['mmm', 'installs']
) }}

-- Daily install counts from device-level Adjust data
-- Uses v_stg_adjust__installs which already has AD_PARTNER mapping
-- Grain: one row per DATE + PLATFORM + CHANNEL

SELECT
    DATE(INSTALL_TIMESTAMP) AS DATE,
    PLATFORM,
    AD_PARTNER AS CHANNEL,
    COUNT(DISTINCT DEVICE_ID) AS INSTALLS
FROM {{ ref('v_stg_adjust__installs') }}
WHERE INSTALL_TIMESTAMP IS NOT NULL
{% if is_incremental() %}
  AND DATE(INSTALL_TIMESTAMP) >= DATEADD(day, -7, (SELECT MAX(DATE) FROM {{ this }}))
{% endif %}
GROUP BY 1, 2, 3
```

Note: `v_stg_adjust__installs` already contains the AD_PARTNER CASE statement, so no need to re-join network_mapping here. The channel names will match because both use the same taxonomy (the v_stg_adjust view has hardcoded CASE, but the values align with network_mapping.ad_partner).

Add a header comment explaining:
- This model counts daily installs by channel and platform for MMM input
- Source: v_stg_adjust__installs (device-level S3 data, more accurate than API aggregates)
- Uses AD_PARTNER from the installs view for channel taxonomy
- Grain: one row per DATE + PLATFORM + CHANNEL
  </action>
  <verify>
Both files exist and have valid SQL. Verify by reading each file and confirming: (1) all ref() calls point to existing model files in the project, (2) all column names match the source models (check staging model SQL for actual column names), (3) the network_mapping seed join columns are referenced in UPPERCASE for project consistency.
  </verify>
  <done>
Two intermediate models exist: int_mmm__daily_channel_spend aggregates Supermetrics spend at DATE+PLATFORM+CHANNEL grain, int_mmm__daily_channel_installs counts installs from device-level Adjust data at the same grain.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create daily channel revenue model and MMM schema YAML</name>
  <files>
models/intermediate/int_mmm__daily_channel_revenue.sql
models/intermediate/_int_mmm__models.yml
  </files>
  <action>
**File 1: `models/intermediate/int_mmm__daily_channel_revenue.sql`**

CRITICAL DESIGN DECISION: This model uses Adjust API's pre-aggregated revenue data (`stg_adjust__report_daily`) rather than the user-level cohort pipeline (`int_user_cohort__metrics`). Why:
- int_user_cohort__metrics depends on int_adjust_amplitude__device_mapping (never built to production)
- Device mapping is broken for Android (0% match rate)
- Adjust API already has revenue attributed at the campaign/partner level
- This makes the MMM pipeline fully independent of MTA device matching

The tradeoff: Adjust API revenue is revenue-event-date based (not install-cohort-date based). This is acceptable for MMM because:
- MMM uses aggregate time series and infers relationships statistically
- Install-to-revenue lag is captured implicitly in adstock/lag parameters of MMM models
- Using API data ensures complete coverage (all platforms, all channels)

```sql
{{ config(
    materialized='incremental',
    unique_key=['DATE', 'PLATFORM', 'CHANNEL'],
    incremental_strategy='merge',
    tags=['mmm', 'revenue']
) }}

-- Daily revenue by channel and platform for MMM input
-- Source: Adjust API daily report (pre-aggregated, no device matching needed)
-- Note: Revenue is by event date, not install cohort date. MMM models handle
-- the install-to-revenue lag through adstock/lag parameters.
-- Grain: one row per DATE + PLATFORM + CHANNEL

WITH revenue_with_channel AS (
    SELECT
        r.DATE,
        r.PLATFORM,
        COALESCE(nm.AD_PARTNER, r.PARTNER_NAME) AS CHANNEL,
        SUM(r.REVENUE) AS REVENUE,
        SUM(r.ALL_REVENUE) AS ALL_REVENUE,
        SUM(r.AD_REVENUE) AS AD_REVENUE,
        SUM(r.INSTALLS) AS API_INSTALLS  -- for cross-check against S3 installs
    FROM {{ ref('stg_adjust__report_daily') }} r
    -- Note: Snowflake treats unquoted identifiers as case-insensitive.
    -- The seed CSV has lowercase headers (adjust_network_name) but since
    -- quote_columns is not set in dbt_project.yml, Snowflake uppercases them
    -- internally. Using UPPERCASE here for project consistency.
    LEFT JOIN {{ ref('network_mapping') }} nm
        ON r.PARTNER_NAME = nm.ADJUST_NETWORK_NAME
    WHERE r.DATE IS NOT NULL
    {% if is_incremental() %}
      AND r.DATE >= DATEADD(day, -7, (SELECT MAX(DATE) FROM {{ this }}))
    {% endif %}
    GROUP BY 1, 2, 3
)

SELECT
    DATE,
    PLATFORM,
    CHANNEL,
    REVENUE,
    ALL_REVENUE,
    AD_REVENUE,
    API_INSTALLS
FROM revenue_with_channel
```

Add a header comment explaining:
- This model aggregates daily revenue by channel and platform for MMM input
- Source: Adjust API daily report (stg_adjust__report_daily)
- Deliberately avoids dependency on device mapping pipeline (broken for Android)
- Revenue is event-date based, not cohort-date based (acceptable for MMM)
- Grain: one row per DATE + PLATFORM + CHANNEL

**File 2: `models/intermediate/_int_mmm__models.yml`**

Create a schema YAML file documenting all three MMM intermediate models:

```yaml
version: 2

models:
  - name: int_mmm__daily_channel_spend
    description: >
      Daily marketing spend aggregated by channel and platform for MMM input.
      Source: Supermetrics adj_campaign data. Channel taxonomy via network_mapping seed.
    columns:
      - name: DATE
        description: Calendar date of spend
        tests:
          - not_null
      - name: PLATFORM
        description: "iOS or Android"
        tests:
          - not_null
          - accepted_values:
              values: ['iOS', 'Android']
      - name: CHANNEL
        description: "Standardized ad partner name (Meta, Google, TikTok, etc.)"
        tests:
          - not_null
      - name: SPEND
        description: Total marketing cost for this date+platform+channel
      - name: IMPRESSIONS
        description: Total ad impressions
      - name: CLICKS
        description: Total ad clicks
      - name: PAID_INSTALLS
        description: Paid installs reported by Supermetrics

  - name: int_mmm__daily_channel_installs
    description: >
      Daily install counts by channel and platform for MMM input.
      Source: Device-level Adjust S3 install data (v_stg_adjust__installs).
      More accurate than API aggregates because it counts distinct devices.
    columns:
      - name: DATE
        description: Calendar date of install
        tests:
          - not_null
      - name: PLATFORM
        description: "iOS or Android"
        tests:
          - not_null
          - accepted_values:
              values: ['iOS', 'Android']
      - name: CHANNEL
        description: "Standardized ad partner name from AD_PARTNER mapping"
        tests:
          - not_null
      - name: INSTALLS
        description: Count of distinct device IDs installed on this date

  - name: int_mmm__daily_channel_revenue
    description: >
      Daily revenue by channel and platform for MMM input.
      Source: Adjust API daily report (stg_adjust__report_daily).
      Uses pre-aggregated API data to avoid dependency on broken device mapping pipeline.
      Revenue is event-date based (not install-cohort based) -- MMM handles lag statistically.
    columns:
      - name: DATE
        description: Calendar date of revenue events
        tests:
          - not_null
      - name: PLATFORM
        description: "iOS or Android"
        tests:
          - not_null
          - accepted_values:
              values: ['iOS', 'Android']
      - name: CHANNEL
        description: "Standardized ad partner name via network_mapping seed"
        tests:
          - not_null
      - name: REVENUE
        description: "Adjust-reported revenue for this channel"
      - name: ALL_REVENUE
        description: "Adjust all_revenue metric (includes all revenue types)"
      - name: AD_REVENUE
        description: "Ad-based revenue (rewarded video, interstitials, etc.)"
      - name: API_INSTALLS
        description: "Install count from API (for cross-check with S3 installs)"
```

Add uniqueness tests for the composite key `[DATE, PLATFORM, CHANNEL]` on each model using dbt_utils.unique_combination_of_columns (already installed).
  </action>
  <verify>
Both files exist. The revenue model references `stg_adjust__report_daily` (NOT int_user_cohort__metrics or int_adjust_amplitude__device_mapping). The YAML file has schema definitions for all 3 models with not_null tests on the key columns.
  </verify>
  <done>
Revenue intermediate model exists using Adjust API data (independent of broken device mapping), and schema YAML documents all 3 MMM intermediate models with data quality tests.
  </done>
</task>

</tasks>

<verification>
1. Three SQL files exist: int_mmm__daily_channel_spend.sql, int_mmm__daily_channel_installs.sql, int_mmm__daily_channel_revenue.sql
2. Schema YAML exists: _int_mmm__models.yml with tests for all 3 models
3. Revenue model does NOT reference int_adjust_amplitude__device_mapping or int_user_cohort__metrics
4. All models use DATE+PLATFORM+CHANNEL as grain
5. Channel taxonomy is consistent: Supermetrics uses network_mapping seed, installs use AD_PARTNER from v_stg_adjust__installs, revenue uses network_mapping seed
</verification>

<success_criteria>
- Three intermediate MMM models aggregate spend, installs, and revenue at daily+channel+platform grain
- Revenue model is independent of broken device mapping pipeline
- Channel taxonomy is mapped consistently across all three models
- Schema YAML provides documentation and data quality tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-device-id-normalization-fix/03-02-SUMMARY.md`
</output>
