---
phase: 02-device-id-audit
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - .planning/phases/02-device-id-audit/findings/device-id-formats.md
  - .planning/phases/02-device-id-audit/findings/baseline-match-rates.md
  - .planning/phases/02-device-id-audit/findings/ios-att-limitations.md
  - .planning/phases/02-device-id-audit/findings/normalization-strategy.md
autonomous: false

must_haves:
  truths:
    - "Documentation shows actual Amplitude DEVICE_ID format for Android and iOS with real production examples"
    - "Baseline match rate metrics exist for Android GPS_ADID, iOS IDFA, and iOS IDFV before any code changes"
    - "iOS ATT limitations are explained in non-technical terms with industry context and business impact"
    - "Normalization strategy document specifies concrete transformations needed for Phase 3 with before/after examples"
  artifacts:
    - path: ".planning/phases/02-device-id-audit/findings/device-id-formats.md"
      provides: "Device ID format audit results with real production data"
      contains: "Amplitude"
    - path: ".planning/phases/02-device-id-audit/findings/baseline-match-rates.md"
      provides: "Baseline match rates by platform and ID type"
      contains: "MATCH_RATE"
    - path: ".planning/phases/02-device-id-audit/findings/ios-att-limitations.md"
      provides: "Stakeholder-facing iOS ATT explanation"
      contains: "App Tracking Transparency"
    - path: ".planning/phases/02-device-id-audit/findings/normalization-strategy.md"
      provides: "Phase 3 normalization plan with transformation examples"
      contains: "Phase 3"
  key_links:
    - from: ".planning/phases/02-device-id-audit/findings/normalization-strategy.md"
      to: ".planning/phases/02-device-id-audit/findings/device-id-formats.md"
      via: "Strategy references actual formats discovered in audit"
      pattern: "device-id-formats"
    - from: ".planning/phases/02-device-id-audit/findings/ios-att-limitations.md"
      to: ".planning/phases/02-device-id-audit/findings/baseline-match-rates.md"
      via: "ATT doc references actual match rate numbers from baseline"
      pattern: "baseline"
---

<objective>
Populate documentation artifacts with real query results from the Phase 2 audit queries, then write the iOS ATT stakeholder document and normalization strategy.

Purpose: This plan turns raw SQL query results into the 4 documentation artifacts that satisfy Phase 2 success criteria (DMAP-01, DMAP-02, DMAP-04). The user runs the audit queries from Plan 01 in Snowflake and provides the results. Claude then writes the findings documentation with real data, the stakeholder-facing ATT explanation, and the normalization strategy that will guide Phase 3 implementation.

Output: 4 Markdown files in `.planning/phases/02-device-id-audit/findings/` directory.
</objective>

<execution_context>
@/Users/riley/.claude/get-shit-done/workflows/execute-plan.md
@/Users/riley/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-device-id-audit/02-RESEARCH.md
@.planning/phases/02-device-id-audit/02-01-SUMMARY.md

# Audit queries that were run to produce the results
@analyses/audit_device_id_formats.sql
@analyses/amplitude_device_id_investigation.sql
@analyses/baseline_match_rates.sql

# Existing models to reference in normalization strategy
@models/staging/adjust/v_stg_adjust__installs.sql
@models/intermediate/int_adjust_amplitude__device_mapping.sql
@models/staging/amplitude/v_stg_amplitude__merge_ids.sql
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Run audit queries in Snowflake and provide results</name>
  <action>
Run the 3 SQL analysis files created in Plan 01 in dbt Cloud IDE or Snowflake worksheet. Provide the output for each query.
  </action>
  <instructions>
Run these queries in order in dbt Cloud IDE SQL runner or a Snowflake worksheet:

1. **`analyses/audit_device_id_formats.sql`** - Copy the full file contents, paste into SQL runner, execute. Copy the result table.

2. **`analyses/amplitude_device_id_investigation.sql`** - Copy the full file contents, paste into SQL runner, execute. Copy the result table. NOTE: This has multiple queries (device ID format, ADID column check, MERGE_IDS investigation). Run each section separately if needed.

3. **`analyses/baseline_match_rates.sql`** - Copy the full file contents, paste into SQL runner, execute. Copy the result table.

Paste all results back here. Include column headers. If any query errors out, paste the error message -- the executor will adapt the query.

Expected time: 5-10 minutes (queries are scoped to 30-60 day windows).
  </instructions>
  <resume-signal>Paste query results for all 3 SQL files, or say "skip" to use template placeholders instead</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Write device ID format findings and baseline match rate documentation</name>
  <files>.planning/phases/02-device-id-audit/findings/device-id-formats.md, .planning/phases/02-device-id-audit/findings/baseline-match-rates.md</files>
  <action>
Using the query results from Task 1, create two documentation files. If user said "skip", use the research estimates as placeholder values with clear [PLACEHOLDER] markers.

**File 1: `.planning/phases/02-device-id-audit/findings/device-id-formats.md`**

Structure:
- Title: "Device ID Format Audit Results"
- Date, query source reference (analyses/audit_device_id_formats.sql, analyses/amplitude_device_id_investigation.sql)
- Summary paragraph

**Findings by Platform** section with subsections:
- **Android (Adjust)**: Table showing GPS_ADID, ADID, IDFV, IDFA population %, format (UUID? length? casing?), 3 example values. Key discovery about IDFA = GPS_ADID on Android.
- **iOS (Adjust)**: Same table structure. Key discovery about IDFV 100% populated, IDFA limited by ATT.
- **Android (Amplitude)**: DEVICE_ID format, length, UUID check, trailing 'R' suffix analysis, sample values. CRITICAL finding about whether it's random or GPS_ADID-based.
- **iOS (Amplitude)**: DEVICE_ID format, confirmation that it matches IDFV.
- **Amplitude MERGE_IDS**: What the table contains, whether it has cross-device mapping potential.

**Implications for Matching** section:
- iOS: What works, what doesn't, why
- Android: What's broken, what the format mismatch is, what options exist

**Open Questions Resolved** section:
- Answer each of the 4 open questions from 02-RESEARCH.md based on actual data

**File 2: `.planning/phases/02-device-id-audit/findings/baseline-match-rates.md`**

Structure:
- Title: "Baseline Device ID Match Rates"
- Date, query source reference
- IMPORTANT note: "These are PRE-normalization baselines. Run again after Phase 3 for comparison."

**Summary Table** (the key deliverable):
```
| Platform | Match Type | Adjust Devices | Amplitude Devices | Matched | Match Rate |
```

**Detailed Breakdown** sections:
- Android GPS_ADID direct match: rate, interpretation
- Android GPS_ADID R-stripped match: rate, interpretation (does stripping R help at all?)
- iOS IDFV match: rate, interpretation
- iOS IDFA match: rate, interpretation, ATT context
- Current device mapping model state: what's in the table now

**Key Findings** section:
- Is Android match rate truly 0% or does some matching work?
- What is the actual iOS match rate via IDFV (should be higher than IDFA-only)?
- How stale is the existing device mapping model data?

**Phase 3 Targets** section:
- Based on these baselines, what improvement targets are realistic?
  </action>
  <verify>
Both files exist in `.planning/phases/02-device-id-audit/findings/`. Each file:
- Contains real data from query results (or [PLACEHOLDER] markers if skip mode)
- Has date and query source references
- Includes platform breakdown (Android and iOS)
- device-id-formats.md answers the 4 open research questions
- baseline-match-rates.md includes summary table with match rates
  </verify>
  <done>
Device ID format audit documents actual Amplitude DEVICE_ID format for both platforms with production examples (DMAP-01). Baseline match rates document covers all match types with real numbers (DMAP-02).
  </done>
</task>

<task type="auto">
  <name>Task 3: Write iOS ATT stakeholder doc and normalization strategy</name>
  <files>.planning/phases/02-device-id-audit/findings/ios-att-limitations.md, .planning/phases/02-device-id-audit/findings/normalization-strategy.md</files>
  <action>
**File 1: `.planning/phases/02-device-id-audit/findings/ios-att-limitations.md`**

Stakeholder-facing document explaining iOS match rate limitations. Follow the template from 02-RESEARCH.md Pattern 3 but customize with REAL data from the audit.

Audience: Product, Marketing, Leadership (NON-TECHNICAL)

Required sections:
- **Summary**: One paragraph with the actual match rate number and "expected and structural, not a bug"
- **Why This Happens**: Explain ATT in plain English. No acronyms without inline definitions. Use the analogy: "Apple requires apps to ask permission to track users across apps. Most users say no."
- **Industry Context (2026)**: Table with global ATT consent (46-50%), gaming apps (12-19%), our observed rate. Source: research findings.
- **What We CAN Measure** (bulleted list): iOS users who consented, aggregate attribution via SKAdNetwork
- **What We CANNOT Measure** (bulleted list): Individual iOS user journeys for 98%+ users, touchpoint-level attribution for non-consented
- **Business Impact**: How this affects MTA on iOS, why Android MTA is still viable, what aggregate iOS attribution can still do
- **What We're Doing**: Phase 3 will maximize matches we CAN make, but cannot change ATT consent rates
- **FAQ**: 2-3 common questions ("Can we fix this?", "Is this a data quality issue?", "What about Android?")

Tone: Confident, factual, empathetic to stakeholder frustration. Do NOT minimize the limitation. Do NOT promise fixes that aren't possible.

Do NOT use emojis in this document.

**File 2: `.planning/phases/02-device-id-audit/findings/normalization-strategy.md`**

Technical document for the engineering team specifying what Phase 3 must implement. Reference actual findings from the audit.

Required sections:
- **Summary**: One paragraph explaining the normalization problem and proposed solution
- **Current State**: Table showing current matching logic in `int_adjust_amplitude__device_mapping.sql` with actual code snippets
- **Problem Analysis by Platform**:
  - iOS: Current normalization (UPPER) is correct. IDFV match works. No changes needed.
  - Android: Current normalization (strip 'R' suffix) does NOT produce GPS_ADID. Explain WHY based on audit findings (Amplitude uses random device IDs, not GPS_ADID).
- **Proposed Transformations**: For each platform, show concrete before/after examples:
  ```
  Adjust GPS_ADID:  A1B2C3D4-E5F6-7890-ABCD-EF1234567890
  Amplitude DEVICE_ID: [actual format from audit]
  After normalization: [what it should become]
  Match result: [yes/no and why]
  ```
- **Android Strategy Options** (ranked by feasibility):
  1. Check if Amplitude has ADID field in events (from audit results)
  2. Check MERGE_IDS for GPS_ADID mapping (from audit results)
  3. Request Amplitude SDK configuration change (external dependency, flag for stakeholder)
  4. Use static `ADJUST_AMPLITUDE_DEVICE_MAPPING` table as bridge (stale since Nov 2025, but may be only option)
- **Implementation Recommendations for Phase 3**:
  - Which files need to change
  - Whether full-refresh is needed
  - Risk assessment for each strategy
- **Success Metrics**: Target match rates for Phase 3 based on baseline
- **Dependencies**: External dependencies (SDK changes, Amplitude support) that are outside dbt scope

Cross-reference the device-id-formats.md and baseline-match-rates.md findings documents explicitly (use relative links).
  </action>
  <verify>
Both files exist. The iOS ATT doc:
- Uses NO technical jargon without explanation
- Contains real match rate numbers from the audit
- Has industry context section with ATT consent rates
- Includes CAN/CANNOT measure sections
- Has FAQ section

The normalization strategy:
- References actual audit findings (not hypothetical)
- Contains concrete before/after transformation examples
- Lists ranked Android strategy options
- Specifies which files need Phase 3 changes
- Cross-references other findings documents
  </verify>
  <done>
iOS ATT stakeholder document explains 1.4% match rate as structural ATT limitation with business context (DMAP-04). Normalization strategy specifies concrete Phase 3 transformations based on audit findings (roadmap success criteria 4).
  </done>
</task>

</tasks>

<verification>
All 4 documentation artifacts exist in `.planning/phases/02-device-id-audit/findings/`:
1. `device-id-formats.md` - Contains actual device ID formats by platform with examples (DMAP-01)
2. `baseline-match-rates.md` - Contains match rates for Android GPS_ADID, iOS IDFA, iOS IDFV (DMAP-02)
3. `ios-att-limitations.md` - Stakeholder-facing ATT explanation (DMAP-04)
4. `normalization-strategy.md` - Concrete transformation examples for Phase 3 (roadmap criteria 4)

Phase 2 success criteria from roadmap:
- [x] Documentation showing actual Amplitude DEVICE_ID format for Android and iOS with real examples
- [x] Baseline match rate metrics exist before any code changes
- [x] iOS ATT limitations documented with stakeholder-facing explanation
- [x] Normalization strategy with concrete transformation examples
</verification>

<success_criteria>
- 4 Markdown files exist with real data from audit queries (or marked [PLACEHOLDER] if queries were skipped)
- Device ID formats documented for both platforms across both systems
- Baseline match rates captured as pre-normalization reference
- iOS ATT doc is readable by non-technical stakeholders
- Normalization strategy provides actionable Phase 3 implementation guidance
- All open research questions answered with evidence from actual data
</success_criteria>

<output>
After completion, create `.planning/phases/02-device-id-audit/02-02-SUMMARY.md`
</output>
