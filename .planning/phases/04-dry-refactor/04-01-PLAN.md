---
phase: 04-dry-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - macros/map_ad_partner.sql
  - models/staging/adjust/v_stg_adjust__installs.sql
  - models/staging/adjust/v_stg_adjust__touchpoints.sql
  - packages.yml
autonomous: true

must_haves:
  truths:
    - "AD_PARTNER mapping logic exists in exactly one place (macros/map_ad_partner.sql), not duplicated across staging models"
    - "Both v_stg_adjust__installs and v_stg_adjust__touchpoints call the macro instead of inlining the CASE statement"
    - "Macro includes Tapjoy (LIKE 'Tapjoy%') and TikTok_Paid_Ads_Android coverage that original CASE was missing"
    - "dbt compile succeeds with no SQL errors after refactoring"
  artifacts:
    - path: "macros/map_ad_partner.sql"
      provides: "Reusable AD_PARTNER CASE statement macro"
      contains: "macro map_ad_partner"
    - path: "models/staging/adjust/v_stg_adjust__installs.sql"
      provides: "Installs staging model using macro instead of inline CASE"
      contains: "map_ad_partner"
    - path: "models/staging/adjust/v_stg_adjust__touchpoints.sql"
      provides: "Touchpoints staging model using macro instead of inline CASE"
      contains: "map_ad_partner"
    - path: "packages.yml"
      provides: "audit_helper package dependency for future verification"
      contains: "audit_helper"
  key_links:
    - from: "models/staging/adjust/v_stg_adjust__installs.sql"
      to: "macros/map_ad_partner.sql"
      via: "Jinja macro call"
      pattern: "map_ad_partner\\('NETWORK_NAME'\\)"
    - from: "models/staging/adjust/v_stg_adjust__touchpoints.sql"
      to: "macros/map_ad_partner.sql"
      via: "Jinja macro call"
      pattern: "map_ad_partner\\('NETWORK_NAME'\\)"
---

<objective>
Extract the duplicated AD_PARTNER CASE statement from v_stg_adjust__installs.sql and v_stg_adjust__touchpoints.sql into a single reusable macro at macros/map_ad_partner.sql. Fix two coverage gaps (Tapjoy, TikTok_Paid_Ads_Android) during extraction. Add audit_helper package for verification support.

Purpose: Eliminate maintenance risk from duplicated mapping logic that can drift between models. Centralizing in a macro means future network additions happen in one place.
Output: One new macro file, two updated staging models, updated packages.yml. All models compile successfully.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-dry-refactor/04-RESEARCH.md
@models/staging/adjust/v_stg_adjust__installs.sql
@models/staging/adjust/v_stg_adjust__touchpoints.sql
@packages.yml
@macros/generate_schema_name.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AD_PARTNER macro and update both staging models</name>
  <files>
    macros/map_ad_partner.sql
    models/staging/adjust/v_stg_adjust__installs.sql
    models/staging/adjust/v_stg_adjust__touchpoints.sql
    packages.yml
  </files>
  <action>
**Step 1: Create `macros/map_ad_partner.sql`**

Create the macro file with the following exact content. Use `{%- macro ... -%}` whitespace-stripped syntax. The macro accepts a column_name argument (string) and returns a CASE statement.

The CASE statement must include ALL conditions from the current inline CASE plus two new coverage additions:
- Add `'TikTok_Paid_Ads_Android'` to the TikTok IN list (existing list has only iOS and SAN variants)
- Add `WHEN {{ column_name }} LIKE 'Tapjoy%' THEN 'Tapjoy'` as a new condition (currently missing entirely)

Include a Jinja comment block at the top documenting purpose, args, return value, and example usage.

Full CASE conditions in order:
1. Meta: IN ('Facebook Installs', 'Instagram Installs', 'Off-Facebook Installs', 'Facebook Messenger Installs')
2. Google: IN ('Google Ads ACE', 'Google Ads ACI', 'Google Organic Search', 'google')
3. TikTok: IN ('TikTok SAN', 'TikTok_Paid_Ads_iOS', 'TikTok_Paid_Ads_Android', 'Tiktok Installs') -- NOTE: added TikTok_Paid_Ads_Android
4. Apple: = 'Apple Search Ads'
5. AppLovin: LIKE 'AppLovin%'
6. Unity: LIKE 'UnityAds%'
7. Moloco: LIKE 'Moloco%'
8. Smadex: LIKE 'Smadex%'
9. AdAction: LIKE 'AdAction%'
10. Vungle: LIKE 'Vungle%'
11. Tapjoy: LIKE 'Tapjoy%' -- NOTE: new addition
12. Organic: = 'Organic'
13. Unattributed: = 'Unattributed'
14. Untrusted: = 'Untrusted Devices'
15. WGT: IN ('wgtgolf', 'WGT_Events_SocialPosts_iOS', 'WGT_GiftCards_Social')
16. Phigolf: LIKE 'Phigolf%'
17. Ryder Cup: LIKE 'Ryder%'
18. ELSE 'Other'

**Step 2: Update `models/staging/adjust/v_stg_adjust__installs.sql`**

Replace the inline CASE statement (lines 65-83 in current file) with a macro call:
```sql
     , {{ map_ad_partner('NETWORK_NAME') }} AS AD_PARTNER
```

Keep all other SQL exactly as-is. The macro call replaces the entire CASE...END block. Preserve the surrounding column list formatting (comma-first style).

**Step 3: Update `models/staging/adjust/v_stg_adjust__touchpoints.sql`**

Replace the inline CASE statement (lines 140-158 in current file) with the same macro call:
```sql
     , {{ map_ad_partner('NETWORK_NAME') }} AS AD_PARTNER
```

Keep all other SQL exactly as-is, including the incremental config block, all CTEs, and the final SELECT column list. Only the CASE block changes.

**Step 4: Update `packages.yml`**

Add audit_helper package. Final packages.yml should be:
```yaml
packages:
  - package: dbt-labs/dbt_utils
    version: [">=1.1.1", "<2.0.0"]
  - package: dbt-labs/audit_helper
    version: 0.12.0
```

**Step 5: Install packages**

Run `dbt deps` to install audit_helper. If dbt is not available locally (key-pair auth issue), this is expected -- note it and move on. The package will be installed when dbt Cloud runs.
  </action>
  <verify>
1. `macros/map_ad_partner.sql` exists and contains `{%- macro map_ad_partner(column_name) -%}` with all 18 CASE conditions (including Tapjoy and TikTok_Paid_Ads_Android)
2. `v_stg_adjust__installs.sql` contains `{{ map_ad_partner('NETWORK_NAME') }}` and does NOT contain any inline `CASE WHEN NETWORK_NAME` block
3. `v_stg_adjust__touchpoints.sql` contains `{{ map_ad_partner('NETWORK_NAME') }}` and does NOT contain any inline `CASE WHEN NETWORK_NAME` block
4. `packages.yml` contains `audit_helper` entry
5. Run `dbt compile --select v_stg_adjust__installs v_stg_adjust__touchpoints` -- if dbt unavailable locally, verify by reading compiled SQL pattern from macro instead
  </verify>
  <done>
- macros/map_ad_partner.sql exists with documented macro containing all 18 CASE conditions
- Both staging models call `{{ map_ad_partner('NETWORK_NAME') }}` instead of inline CASE
- No CASE WHEN NETWORK_NAME duplication exists anywhere in the staging models
- packages.yml includes audit_helper 0.12.0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create singular test for AD_PARTNER mapping regression</name>
  <files>
    tests/singular/test_ad_partner_mapping_consistency.sql
  </files>
  <action>
Create directory `tests/singular/` if it does not exist (tests/ exists with only .gitkeep).

Create `tests/singular/test_ad_partner_mapping_consistency.sql` -- a singular dbt test that validates the macro produces correct AD_PARTNER values for all known NETWORK_NAME inputs.

The test should:
1. Define a CTE `known_mappings` with UNION ALL SELECT statements for every NETWORK_NAME that has a known expected AD_PARTNER. Include at least one representative from each CASE condition (all 18 branches including ELSE):
   - 'Facebook Installs' -> 'Meta'
   - 'Instagram Installs' -> 'Meta'
   - 'Google Ads ACE' -> 'Google'
   - 'google' -> 'Google'
   - 'TikTok SAN' -> 'TikTok'
   - 'TikTok_Paid_Ads_Android' -> 'TikTok' (new coverage)
   - 'Apple Search Ads' -> 'Apple'
   - 'AppLovin_iOS_2019' -> 'AppLovin'
   - 'UnityAds_2023_iOS_Launch_Campaign' -> 'Unity'
   - 'Moloco_DSP_iOS' -> 'Moloco'
   - 'Smadex DSP - iOS' -> 'Smadex'
   - 'AdAction_iOS_2021' -> 'AdAction'
   - 'Vungle_Something' -> 'Vungle'
   - 'Tapjoy' -> 'Tapjoy' (new coverage)
   - 'Tapjoy_Android_CPE_Campaign2021' -> 'Tapjoy' (LIKE pattern test)
   - 'Organic' -> 'Organic'
   - 'Unattributed' -> 'Unattributed'
   - 'Untrusted Devices' -> 'Untrusted'
   - 'wgtgolf' -> 'WGT'
   - 'Phigolf_2024' -> 'Phigolf'
   - 'Ryder_Cup_Campaign' -> 'Ryder Cup'
   - 'SomeUnknownNetwork' -> 'Other' (ELSE branch)

2. Define a CTE `actual_output` that calls `{{ map_ad_partner('network_name') }}` on the known_mappings CTE's network_name column to get the actual AD_PARTNER value.

3. Final SELECT returns rows where `expected_partner != actual_partner` (mismatches). In dbt, a singular test passes when it returns ZERO rows.

Add a SQL comment header explaining the test purpose and that it validates the `map_ad_partner` macro.

After creating the test, attempt `dbt compile --select test_ad_partner_mapping_consistency` to verify it compiles. If dbt is not available locally, this is expected -- note it for dbt Cloud validation in Phase 5.
  </action>
  <verify>
1. `tests/singular/test_ad_partner_mapping_consistency.sql` exists
2. File contains `{{ map_ad_partner('network_name') }}` macro call
3. File has test cases for all 18 CASE branches including Tapjoy and TikTok_Paid_Ads_Android
4. File returns only mismatched rows (zero rows = pass)
5. `dbt compile --select test_ad_partner_mapping_consistency` succeeds (or is documented as pending dbt Cloud)
  </verify>
  <done>
- Singular test file exists at tests/singular/test_ad_partner_mapping_consistency.sql
- Test covers all 18 CASE conditions with at least one representative NETWORK_NAME each
- Test includes both new coverage additions (Tapjoy, TikTok_Paid_Ads_Android)
- Test will pass when macro is correct and fail if any mapping drifts
  </done>
</task>

</tasks>

<verification>
1. Grep for inline CASE WHEN NETWORK_NAME in staging models -- should return ZERO matches (only macro calls remain)
2. Grep for map_ad_partner in both staging models -- should return exactly 1 match per file
3. Grep for 'Tapjoy' in macros/map_ad_partner.sql -- should be present (coverage gap fix)
4. Grep for 'TikTok_Paid_Ads_Android' in macros/map_ad_partner.sql -- should be present (coverage gap fix)
5. `dbt compile` on all modified models and tests succeeds (or documented for dbt Cloud)
</verification>

<success_criteria>
- CODE-01 satisfied: AD_PARTNER CASE statement extracted into macros/map_ad_partner.sql, not duplicated across staging models
- CODE-02 satisfied: Singular test validates macro produces correct AD_PARTNER for all known NETWORK_NAME inputs
- CODE-04 satisfied: Both v_stg_adjust__installs and v_stg_adjust__touchpoints use the same macro call, guaranteeing identical AD_PARTNER output for identical NETWORK_NAME input
- Two coverage gaps fixed: Tapjoy and TikTok_Paid_Ads_Android now mapped correctly instead of falling to 'Other'
- audit_helper package available for Phase 5 verification work
</success_criteria>

<output>
After completion, create `.planning/phases/04-dry-refactor/04-01-SUMMARY.md`
</output>
