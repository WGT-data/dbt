---
phase: 05-mmm-pipeline-hardening-expand-test-coverage
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - seeds/network_mapping.csv
  - models/intermediate/int_mmm__daily_channel_spend.sql
  - models/intermediate/int_mmm__daily_channel_installs.sql
  - models/intermediate/int_mmm__daily_channel_revenue.sql
  - models/marts/mmm/mmm__daily_channel_summary.sql
  - models/marts/mmm/mmm__weekly_channel_summary.sql
  - tests/singular/test_mmm_date_spine_completeness.sql
  - tests/singular/test_mmm_cross_layer_consistency.sql
  - tests/singular/test_mmm_zero_fill_integrity.sql
autonomous: false

must_haves:
  truths:
    - "All 5 MMM models compile successfully in dbt Cloud with no SQL errors"
    - "Incremental intermediate models run both full-refresh and incremental without data duplication"
    - "Network mapping seed covers all active PARTNER_NAME values (no unmapped partners with significant spend)"
    - "MMM daily summary KPIs (CPI, ROAS) have no division-by-zero errors"
    - "All 3 singular tests pass in dbt Cloud (date spine, cross-layer, zero-fill)"
  artifacts:
    - path: "seeds/network_mapping.csv"
      provides: "Complete partner mapping covering all active ad partners"
    - path: "models/intermediate/int_mmm__daily_channel_spend.sql"
      provides: "Validated incremental spend model"
    - path: "models/marts/mmm/mmm__daily_channel_summary.sql"
      provides: "Validated daily summary with correct KPIs"
  key_links:
    - from: "int_mmm__daily_channel_spend"
      to: "mmm__daily_channel_summary"
      via: "ref() and LEFT JOIN"
      pattern: "ref\\('int_mmm__daily_channel_spend'\\)"
    - from: "mmm__daily_channel_summary"
      to: "mmm__weekly_channel_summary"
      via: "ref() downstream aggregation"
      pattern: "ref\\('mmm__daily_channel_summary'\\)"
---

<objective>
Validate the entire MMM pipeline in dbt Cloud: compile all models, run full-refresh and incremental, check network mapping coverage, run all tests, and fix any issues discovered.

Purpose: Models were built locally without dbt compilation (key-pair auth blocks local dbt). This plan validates everything actually works in dbt Cloud and fixes any issues found during validation.

Output: All MMM models running successfully in dbt Cloud, all tests passing, network mapping coverage confirmed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mmm-pipeline-hardening-expand-test-coverage/05-RESEARCH.md
@.planning/phases/05-mmm-pipeline-hardening-expand-test-coverage/05-01-SUMMARY.md
@models/intermediate/int_mmm__daily_channel_spend.sql
@models/intermediate/int_mmm__daily_channel_installs.sql
@models/intermediate/int_mmm__daily_channel_revenue.sql
@models/marts/mmm/mmm__daily_channel_summary.sql
@models/marts/mmm/mmm__weekly_channel_summary.sql
@seeds/network_mapping.csv
@tests/singular/test_mmm_date_spine_completeness.sql
@tests/singular/test_mmm_cross_layer_consistency.sql
@tests/singular/test_mmm_zero_fill_integrity.sql
@analysis/check_network_mapping_coverage.sql
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Validate MMM pipeline in dbt Cloud</name>
  <what-built>
Complete MMM pipeline (3 intermediate models, 2 marts, 3 singular tests, 1 analysis query) built across Phases 3-5. All code written locally but never compiled or executed in dbt Cloud due to local key-pair auth issue.
  </what-built>
  <how-to-verify>
Run these commands in dbt Cloud IDE in order. After EACH step, report the result (success or error message) before proceeding to the next.

**Step 1: Install packages**
```
dbt deps
```
Expected: "All packages installed successfully" (installs dbt-utils, audit_helper)

**Step 2: Seed network mapping**
```
dbt seed --select network_mapping
```
Expected: Seed loads 29 rows successfully

**Step 3: Compile all MMM models (check for SQL syntax errors)**
```
dbt compile --select tag:mmm
```
Expected: All 5 models compile with no errors

**Step 4: Run intermediate models with full-refresh**
```
dbt run --select int_mmm__daily_channel_spend int_mmm__daily_channel_installs int_mmm__daily_channel_revenue --full-refresh
```
Expected: All 3 models run successfully, creates tables in dev schema

**Step 5: Run intermediate models incrementally (test merge behavior)**
```
dbt run --select int_mmm__daily_channel_spend int_mmm__daily_channel_installs int_mmm__daily_channel_revenue
```
Expected: All 3 models run successfully with incremental merge. Row counts should be SAME as full-refresh (merge upserts, not appends).

**Step 6: Run mart models**
```
dbt run --select mmm__daily_channel_summary mmm__weekly_channel_summary
```
Expected: Both mart models run successfully as table materialization

**Step 7: Run all tests on MMM models**
```
dbt test --select tag:mmm test_mmm_date_spine_completeness test_mmm_cross_layer_consistency test_mmm_zero_fill_integrity test_ad_partner_mapping_consistency
```
Expected: All tests pass (including generic tests from schema YAML + all 4 singular tests)

**Step 8: Check network mapping coverage**
```
dbt compile --select check_network_mapping_coverage
```
Then copy the compiled SQL from target/compiled/ and run it in a Snowflake worksheet. Report the output (which partners are mapped vs unmapped).

**Report format for each step:**
- Step N: PASS / FAIL
- If FAIL: Copy the full error message
- For Step 5: Report row counts of each intermediate model
- For Step 8: List any UNMAPPED partners and their source
  </how-to-verify>
  <resume-signal>Report results for all 8 steps. Type "all pass" if everything succeeded, or paste error details for any failures.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Fix any issues from dbt Cloud validation</name>
  <files>
    seeds/network_mapping.csv
    models/intermediate/int_mmm__daily_channel_spend.sql
    models/intermediate/int_mmm__daily_channel_installs.sql
    models/intermediate/int_mmm__daily_channel_revenue.sql
    models/marts/mmm/mmm__daily_channel_summary.sql
    models/marts/mmm/mmm__weekly_channel_summary.sql
    tests/singular/test_mmm_date_spine_completeness.sql
    tests/singular/test_mmm_cross_layer_consistency.sql
    tests/singular/test_mmm_zero_fill_integrity.sql
  </files>
  <action>
Based on the checkpoint results, fix any issues found. Common fixes include:

**Compilation errors (Steps 3-6):**
- Fix Jinja syntax errors in model SQL
- Fix column name mismatches between models
- Fix ref() paths if model names don't match

**Incremental duplication (Step 5):**
- Verify unique_key array matches actual grain columns
- Verify is_incremental() filter logic
- Check if lookback window creates unexpected overlap

**Test failures (Step 7):**
- Date spine test fails: Check if date_spine macro generates dates correctly, verify CROSS JOIN logic
- Cross-layer test fails: Check if HAS_*_DATA filter is correct, verify tolerance thresholds
- Zero-fill test fails: Check CASE WHEN IS NOT NULL logic in daily summary model

**Network mapping gaps (Step 8):**
- Add unmapped partners to seeds/network_mapping.csv with correct ad_partner value
- Use existing AD_PARTNER taxonomy (Meta, Google, TikTok, Apple, AppLovin, Unity, Moloco, Smadex, AdAction, Tapjoy, Vungle, Organic, Unattributed)
- For genuinely new partners not in taxonomy, add new row with appropriate ad_partner grouping

**If all steps passed:** No fixes needed. Skip this task and note "All validation passed - no fixes required" in summary.

After any fixes, instruct the user to re-run the failing dbt commands in dbt Cloud to confirm fixes.
  </action>
  <verify>
If fixes were made:
- All modified files have valid SQL/CSV syntax
- Changes address the specific errors reported in Task 1
- User confirms re-run succeeds in dbt Cloud

If no fixes needed:
- Confirm all 8 steps passed
  </verify>
  <done>
All MMM models compile and run in dbt Cloud. Incremental models handle both full-refresh and incremental without duplication. All singular tests pass. Network mapping covers all active partners (or known gaps documented).
  </done>
</task>

</tasks>

<verification>
Phase 5 success criteria verified in dbt Cloud:
1. `dbt compile --select tag:mmm` compiles all 5 models with no errors (MMM-01)
2. Incremental models produce same row counts on full-refresh and incremental runs (MMM-02)
3. Network mapping analysis shows 0 unmapped active partners, or gaps resolved (MMM-03)
4. `dbt run --select mmm__daily_channel_summary` completes with no division-by-zero errors (MMM-04)
5. `dbt test --select test_mmm_date_spine_completeness` passes (TEST-06)
6. `dbt test --select test_mmm_cross_layer_consistency` passes (TEST-07)
7. `dbt test --select test_mmm_zero_fill_integrity` passes (TEST-08)
</verification>

<success_criteria>
- All 5 MMM models compile and run in dbt Cloud without SQL errors
- Incremental intermediate models handle full-refresh and incremental runs without data duplication
- Network mapping seed covers all active PARTNER_NAME values (no unmapped channels with significant spend)
- MMM daily summary produces correct KPIs with no division-by-zero errors
- All 3 new singular tests pass (date spine, cross-layer, zero-fill)
- All existing generic tests on MMM models pass (unique combo, not_null, accepted_values)
</success_criteria>

<output>
After completion, create `.planning/phases/05-mmm-pipeline-hardening-expand-test-coverage/05-02-SUMMARY.md`
</output>
