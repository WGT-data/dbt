{{config(materialized = "table")}}

-- Device Mapping Distribution Summary
-- Executive summary showing impact of multi-device users on data quality
-- Use this to communicate the fan-out issue to stakeholders

WITH DEVICE_MAPPING AS (
    SELECT *
    FROM {{ ref('int_adjust_amplitude__device_mapping') }}
)

, USER_DEVICE_COUNTS AS (
    SELECT AMPLITUDE_USER_ID
         , COUNT(DISTINCT ADJUST_DEVICE_ID) AS DEVICE_COUNT
    FROM DEVICE_MAPPING
    WHERE AMPLITUDE_USER_ID IS NOT NULL
    GROUP BY AMPLITUDE_USER_ID
)

, BUCKETED AS (
    SELECT AMPLITUDE_USER_ID
         , DEVICE_COUNT
         , CASE 
             WHEN DEVICE_COUNT = 1 THEN '01. 1 device'
             WHEN DEVICE_COUNT BETWEEN 2 AND 5 THEN '02. 2-5 devices'
             WHEN DEVICE_COUNT BETWEEN 6 AND 10 THEN '03. 6-10 devices'
             WHEN DEVICE_COUNT BETWEEN 11 AND 50 THEN '04. 11-50 devices'
             WHEN DEVICE_COUNT BETWEEN 51 AND 100 THEN '05. 51-100 devices'
             WHEN DEVICE_COUNT BETWEEN 101 AND 500 THEN '06. 101-500 devices'
             WHEN DEVICE_COUNT BETWEEN 501 AND 1000 THEN '07. 501-1000 devices'
             ELSE '08. 1000+ devices'
           END AS DEVICE_COUNT_BUCKET
    FROM USER_DEVICE_COUNTS
)

, TOTALS AS (
    SELECT COUNT(DISTINCT AMPLITUDE_USER_ID) AS TOTAL_USERS
         , SUM(DEVICE_COUNT) AS TOTAL_MAPPINGS
    FROM BUCKETED
)

SELECT B.DEVICE_COUNT_BUCKET
     , COUNT(DISTINCT B.AMPLITUDE_USER_ID) AS USERS_IN_BUCKET
     , SUM(B.DEVICE_COUNT) AS TOTAL_DEVICE_MAPPINGS
     , MIN(B.DEVICE_COUNT) AS MIN_DEVICES
     , MAX(B.DEVICE_COUNT) AS MAX_DEVICES
     , ROUND(100.0 * COUNT(DISTINCT B.AMPLITUDE_USER_ID) / T.TOTAL_USERS, 4) AS PCT_OF_USERS
     , ROUND(100.0 * SUM(B.DEVICE_COUNT) / T.TOTAL_MAPPINGS, 4) AS PCT_OF_MAPPINGS
FROM BUCKETED B
CROSS JOIN TOTALS T
GROUP BY B.DEVICE_COUNT_BUCKET
     , T.TOTAL_USERS
     , T.TOTAL_MAPPINGS
ORDER BY B.DEVICE_COUNT_BUCKET
