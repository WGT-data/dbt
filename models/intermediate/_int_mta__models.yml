version: 2

models:
  - name: int_mta__user_journey
    description: |
      Maps all marketing touchpoints (impressions + clicks) to conversions (installs).
      Foundation table for multi-touch attribution calculations.

      Join Logic:
      - Touchpoints within 7-day lookback window before install
      - Touchpoint must be BEFORE install timestamp
      - Includes position information (first touch, last touch, total touchpoints)

      Grain: One row per device + touchpoint + install combination
    columns:
      - name: JOURNEY_ROW_KEY
        description: MD5 hash surrogate key (device_id||platform||touchpoint_type||network||timestamps||campaign||adgroup||creative||match_type)
        data_tests:
          - unique:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
          - not_null:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
      - name: DEVICE_ID
        description: Adjust device identifier (IDFV for iOS, GPS_ADID for Android)
        data_tests:
          - not_null:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
          - relationships:
              to: ref('int_adjust_amplitude__device_mapping')
              field: ADJUST_DEVICE_ID
              config:
                severity: warn
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
              meta:
                comment: "iOS IDFA match rate is structurally ~1.4% due to ATT limitation (DMAP-04). Android device mapping not yet fixed (Phase 3). Using severity warn to track metric without failing builds."
      - name: PLATFORM
        description: iOS or Android
        data_tests:
          - not_null:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
          - accepted_values:
              values: ['iOS', 'Android']
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
      - name: TOUCHPOINT_TYPE
        description: impression or click
      - name: TOUCHPOINT_POSITION
        description: Position in journey from first (1 = first touchpoint)
      - name: TOTAL_TOUCHPOINTS
        description: Total number of touchpoints in this user's journey
      - name: IS_FIRST_TOUCH
        description: 1 if this is the first touchpoint, 0 otherwise
      - name: IS_LAST_TOUCH
        description: 1 if this is the last touchpoint before install, 0 otherwise
      - name: HOURS_TO_INSTALL
        description: Hours between touchpoint and install
      - name: DAYS_TO_INSTALL
        description: Days between touchpoint and install

  - name: int_mta__touchpoint_credit
    description: |
      Calculates attribution credit for each touchpoint using multiple methodologies.
      Each row contains credit scores under all 5 attribution models.

      Attribution Models Calculated:
      - CREDIT_LAST_TOUCH: 100% to last touchpoint
      - CREDIT_FIRST_TOUCH: 100% to first touchpoint
      - CREDIT_LINEAR: Equal split (weighted by type)
      - CREDIT_TIME_DECAY: Half-life decay (3 days)
      - CREDIT_POSITION_BASED: 40/40/20 U-shaped
      - CREDIT_RECOMMENDED: Alias for time-decay

      Grain: One row per device + touchpoint
    columns:
      - name: JOURNEY_ROW_KEY
        description: MD5 hash surrogate key inherited from int_mta__user_journey
        data_tests:
          - unique:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
          - not_null:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
      - name: PLATFORM
        description: iOS or Android
        data_tests:
          - not_null:
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
          - accepted_values:
              values: ['iOS', 'Android']
              config:
                where: "INSTALL_TIMESTAMP >= DATEADD(day, -60, CURRENT_DATE)"
      - name: CREDIT_TIME_DECAY
        description: |
          Attribution credit using time-decay model (recommended).
          Uses exponential decay with 3-day half-life.
          Clicks weighted 2x vs impressions.
      - name: CREDIT_POSITION_BASED
        description: |
          Attribution credit using position-based (U-shaped) model.
          40% to first touch, 40% to last touch, 20% split among middle touches.
